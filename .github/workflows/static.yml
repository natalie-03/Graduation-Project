name: Dcard Crawler Daily (Selenium Ultimate)

on:
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼
  schedule:
    - cron: '0 16 * * *'  # æ¯å¤© UTC 16:00 (å°ç£æ™‚é–“ 00:00)

jobs:
  scrape:
    runs-on: ubuntu-latest
    permissions:
      contents: write # è³¦äºˆ Commit æ¬Šé™

    steps:
      # 1. æª¢å‡ºç¨‹å¼ç¢¼
      - name: Checkout code
        uses: actions/checkout@v4 # å‡ç´šåˆ° v4

      # 2. è¨­å®š Python ç’°å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5 # å‡ç´šåˆ° v5
        with:
          python-version: '3.10'
          cache: 'pip' # å…§å»º cache åŠŸèƒ½ï¼Œä¸éœ€è¦é¡å¤–çš„ cache step

      # 3. å®‰è£ç³»çµ±ç´šä¾è³´ (é—œéµå„ªåŒ–ï¼šXvfb)
      # ä½œç”¨ï¼šå»ºç«‹è™›æ“¬è¢å¹•ï¼Œè®“ Selenium èªç‚ºæœ‰çœŸå¯¦é¡¯ç¤ºå™¨ï¼Œç¹é Headless æª¢æ¸¬
      - name: Install System Dependencies (Xvfb)
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb libxi6 libgconf-2-4

      # 4. å®‰è£ Python ä¾è³´
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install undetected_chromedriver selenium
          if [ -f .github/workflows/requirements.txt ]; then pip install -r .github/workflows/requirements.txt; fi

      # 5. åŸ·è¡Œçˆ¬èŸ² (é—œéµå„ªåŒ–ï¼šä½¿ç”¨ xvfb-run)
      # ä½¿ç”¨ xvfb-run åŒ…è£¹ python æŒ‡ä»¤ï¼Œæ¨¡æ“¬ 1920x1080 è¢å¹•
      - name: Run Crawler with Virtual Display
        timeout-minutes: 15 # ç¨å¾®å»¶é•·æ™‚é–“ä»¥å®¹éŒ¯
        run: |
          xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" python .github/workflows/scraper.py
        env:
          # å¯ä»¥åœ¨é€™è£¡å‚³å…¥ç’°å¢ƒè®Šæ•¸ï¼Œä¾‹å¦‚é€šçŸ¥ç”¨çš„ Webhook
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }} 

      # 6. å¤±æ•—æ™‚ä¸Šå‚³æˆªåœ– (åµéŒ¯ç¥å™¨)
      # å¦‚æœçˆ¬èŸ²å¤±æ•—ï¼Œå°‡ç•¶å‰ç›®éŒ„ä¸‹çš„ screenshots è³‡æ–™å¤¾æ‰“åŒ…ä¸Šå‚³ï¼Œæ–¹ä¾¿ä½ æª¢æŸ¥æ˜¯è¢«æ“‹é‚„æ˜¯ç¨‹å¼éŒ¯èª¤
      - name: Upload Error Screenshots
        if: failure() 
        uses: actions/upload-artifact@v4
        with:
          name: error-screenshots
          path: |
            *.png
            logs/
            error.log

      # 7. æäº¤ä¸¦æ¨é€è³‡æ–™ (å¢å¼·ç‰ˆ)
      - name: Commit and Push Data
        if: success() # åªæœ‰æˆåŠŸæ‰åŸ·è¡Œ
        run: |
          git config --global user.name "Dcard Bot"
          git config --global user.email "actions@github.com"
          
          # å…ˆæ‹‰å–æœ€æ–°ä»£ç¢¼ï¼Œé¿å…è¡çª
          git pull --rebase
          
          # æª¢æŸ¥æ˜¯å¦æœ‰ CSV æª”æ¡ˆè®Šæ›´
          if [ -d "csv" ] && [ "$(ls -A csv)" ]; then
            git add csv
            # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´éœ€è¦æäº¤
            if ! git diff-index --quiet HEAD; then
              git commit -m "ğŸ“… Auto-update Dcard data: $(date +'%Y-%m-%d') [skip ci]"
              git push
            else
              echo "No changes detected."
            fi
          else
            echo "No csv directory or files found."
          fi
